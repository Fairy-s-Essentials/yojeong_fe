name: Build Time vs Code Size (History)

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰

jobs:
  build-history-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.24.0

      - name: Analyze Build Time Across History
        run: |
          echo "# ðŸ“Š Build Time vs Code Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | Date | Files | Lines | Modules (build) | Build Time | Bundle Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|-------|-------|-----------------|------------|-------------|" >> $GITHUB_STEP_SUMMARY
          
          # í˜„ìž¬ ì»¤ë°‹ ì €ìž¥
          CURRENT_COMMIT=$(git rev-parse HEAD)
          
          # ìµœê·¼ 10ê°œ ì»¤ë°‹ ë¶„ì„ (ë„ˆë¬´ ë§Žìœ¼ë©´ ì‹œê°„ ì˜¤ëž˜ ê±¸ë¦¼)
          COMMITS=$(git log --oneline -10 --pretty=format:"%H" | tac)
          
          for COMMIT in $COMMITS; do
            echo ""
            echo "=========================================="
            echo "Analyzing commit: $COMMIT"
            echo "=========================================="
            
            # ì»¤ë°‹ìœ¼ë¡œ ì²´í¬ì•„ì›ƒ
            git checkout $COMMIT
            
            # ì»¤ë°‹ ì •ë³´
            COMMIT_SHORT=$(git log -1 --pretty=format:"%h")
            COMMIT_DATE=$(git log -1 --pretty=format:"%ai" | cut -d' ' -f1)
            COMMIT_MSG=$(git log -1 --pretty=format:"%s" | cut -c1-30)
            
            # íŒŒì¼ ìˆ˜
            FILE_COUNT=$(find src -type f \( -name "*.tsx" -o -name "*.ts" \) 2>/dev/null | wc -l || echo "0")
            
            # ì½”ë“œ ë¼ì¸ ìˆ˜
            LINE_COUNT=$(find src -type f \( -name "*.tsx" -o -name "*.ts" \) -exec cat {} + 2>/dev/null | wc -l || echo "0")
            
            echo "Files: $FILE_COUNT"
            echo "Lines: $LINE_COUNT"
            
            # ë¹Œë“œ ì‹œë„ (ì—ëŸ¬ ë‚˜ë„ ê³„ì† ì§„í–‰)
            START_TIME=$(date +%s)
            
            # package.jsonì´ ìžˆëŠ”ì§€ í™•ì¸
            if [ -f "package.json" ]; then
              # pnpm-lock.yamlì´ ì—†ìœ¼ë©´ ìƒì„±
              if [ ! -f "pnpm-lock.yaml" ]; then
                echo "No lockfile, running pnpm install..."
                pnpm install || echo "Install failed"
              else
                pnpm install --frozen-lockfile || pnpm install || echo "Install failed"
              fi
              
              # ë¹Œë“œ ì‹œë„
              BUILD_OUTPUT=$(pnpm run build 2>&1 || echo "Build failed")
              BUILD_SUCCESS=$?
              
              # ëª¨ë“ˆ ìˆ˜ ì¶”ì¶œ (ë¹Œë“œ ì„±ê³µ ì‹œ)
              if [ $BUILD_SUCCESS -eq 0 ]; then
                MODULES=$(echo "$BUILD_OUTPUT" | grep -oP '\d+(?= modules transformed)' | head -1 || echo "N/A")
              else
                MODULES="Failed"
              fi
              
              # ë²ˆë“¤ ì‚¬ì´ì¦ˆ (ë¹Œë“œ ì„±ê³µ ì‹œ)
              if [ -d "dist" ] && [ $BUILD_SUCCESS -eq 0 ]; then
                BUNDLE_SIZE=$(du -sh dist/ 2>/dev/null | cut -f1 || echo "N/A")
              else
                BUNDLE_SIZE="N/A"
              fi
            else
              MODULES="N/A"
              BUNDLE_SIZE="N/A"
              BUILD_SUCCESS=1
            fi
            
            END_TIME=$(date +%s)
            BUILD_TIME=$((END_TIME - START_TIME))
            
            echo "Build time: ${BUILD_TIME}s"
            echo "Modules: $MODULES"
            echo "Bundle size: $BUNDLE_SIZE"
            
            # ê²°ê³¼ ì €ìž¥
            if [ $BUILD_SUCCESS -eq 0 ]; then
              STATUS="âœ…"
            else
              STATUS="âŒ"
              BUILD_TIME="Failed"
            fi
            
            echo "| $STATUS $COMMIT_SHORT | $COMMIT_DATE | $FILE_COUNT | $LINE_COUNT | $MODULES | ${BUILD_TIME}s | $BUNDLE_SIZE |" >> $GITHUB_STEP_SUMMARY
            
            # ë””ìŠ¤í¬ ì •ë¦¬
            rm -rf node_modules dist 2>/dev/null || true
          done
          
          # ì›ëž˜ ì»¤ë°‹ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          git checkout $CURRENT_COMMIT
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Analysis complete!** Check the table above to see how build time correlates with code size." >> $GITHUB_STEP_SUMMARY

      - name: Create visualization data
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ Insights" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Files**: Number of TypeScript/React files" >> $GITHUB_STEP_SUMMARY
          echo "- **Lines**: Total lines of code" >> $GITHUB_STEP_SUMMARY
          echo "- **Modules**: Number of modules transformed during build" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: Time taken to complete the build" >> $GITHUB_STEP_SUMMARY
          echo "- **Bundle Size**: Final dist folder size" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Look for correlation between Lines/Modules and Build Time!" >> $GITHUB_STEP_SUMMARY